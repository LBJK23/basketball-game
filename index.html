<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Basketball Telegram Pro</title>
    <style>
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: #000; position: fixed;
            touch-action: none; -webkit-user-select: none;
        }
        canvas { 
            display: block; width: 100vw; height: 100vh; 
            object-fit: contain; background: #000; 
        }
    </style>
</head>
<body>
    <canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// Константы разрешения
const W = 1280, H = 720;
canvas.width = W; canvas.height = H;

const courtImg = new Image();
courtImg.src = "Basketball-Court-vector-illustra.jpg";

// Состояние игры
let state = "MOVE"; 
let score = 0;
let playerX = W / 2;
let aimAngle = Math.PI / 2;
let powerPoint = 0, powerDir = 0.02, resultText = "";
const ball = { x: 0, y: 0, z: 0, vx: 0, vy: 0, vz: 0, active: false };

// Кнопки с увеличенной областью нажатия
const btns = {
    moveLeft:  { x: 850,  y: 550, w: 130, h: 130, color: "#e74c3c", txt: "◀", active: false },
    moveRight: { x: 1130, y: 550, w: 130, h: 130, color: "#e74c3c", txt: "▶", active: false },
    aimUp:     { x: 990,  y: 410, w: 130, h: 130, color: "#3498db", txt: "▲", active: false },
    aimDown:   { x: 990,  y: 550, w: 130, h: 130, color: "#3498db", txt: "▼", active: false },
    shoot:     { x: 20,   y: 480, w: 220, h: 220, color: "#f39c12", txt: "БРОСОК", active: false }
};

/* ================= ЛОГИКА НАЖАТИЙ ================= */
function checkInput(ex, ey, isRelease = false) {
    const rect = canvas.getBoundingClientRect();
    const x = (ex - rect.left) * (W / rect.width);
    const y = (ey - rect.top) * (H / rect.height);

    for (let key in btns) {
        let b = btns[key];
        if (x > b.x && x < b.x + b.w && y > b.y && y < b.y + b.h) {
            if (isRelease) {
                b.active = false;
            } else {
                b.active = true;
                processAction(key);
            }
        } else if (isRelease) {
            b.active = false;
        }
    }
}

function processAction(action) {
    if (state === "MOVE") {
        if (action === "moveLeft") playerX -= 40;
        if (action === "moveRight") playerX += 40;
    }
    if (state === "AIM_LINE") {
        if (action === "aimUp") aimAngle += 0.15;
        if (action === "aimDown") aimAngle -= 0.15;
    }
    
    if (action === "shoot") {
        if (state === "MOVE") state = "AIM_LINE";
        else if (state === "AIM_LINE") { state = "TIMING"; powerPoint = 0; }
        else if (state === "TIMING") { launch(powerPoint > 0.7); state = "SHOT"; }
        else if (state === "RESULT") { state = "MOVE"; ball.active = false; }
    }
}

// Слушатели событий
canvas.addEventListener("touchstart", e => { 
    e.preventDefault(); 
    checkInput(e.touches[0].clientX, e.touches[0].clientY); 
}, {passive: false});

canvas.addEventListener("touchend", e => {
    for (let key in btns) btns[key].active = false;
});

canvas.addEventListener("mousedown", e => checkInput(e.clientX, e.clientY));
canvas.addEventListener("mouseup", () => { for (let key in btns) btns[key].active = false; });

/* ================= ГЕЙМПЛЕЙ ================= */
function launch(perfect) {
    ball.active = true;
    ball.x = playerX; ball.y = 600;
    const T = 65;
    ball.vx = (640 - ball.x) / T;
    ball.vy = (300 - ball.y - 0.5 * 0.5 * T * T) / T + (perfect ? 0 : 6);
}

function draw() {
    ctx.clearRect(0, 0, W, H);
    if (courtImg.complete) ctx.drawImage(courtImg, 0, 0, W, H);

    if (state === "MOVE") { ball.x = playerX; ball.y = 600; }

    // Линия прицела
    if (state === "AIM_LINE" || state === "TIMING") {
        ctx.strokeStyle = "black"; ctx.lineWidth = 6; ctx.setLineDash([15, 10]);
        ctx.beginPath(); ctx.moveTo(ball.x, ball.y);
        ctx.quadraticCurveTo(ball.x + Math.cos(aimAngle)*250, ball.y - 450, 640, 310);
        ctx.stroke(); ctx.setLineDash([]);
    }

    // Мяч
    ctx.fillStyle = "#e67e22"; ctx.beginPath();
    ctx.arc(ball.x, ball.y, 30, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    // Кнопки
    for (let k in btns) {
        let b = btns[k];
        ctx.fillStyle = b.active ? "#fff" : b.color;
        ctx.globalAlpha = 0.8;
        ctx.beginPath(); ctx.roundRect(b.x, b.y, b.w, b.h, 20); ctx.fill();
        ctx.strokeStyle = "white"; ctx.lineWidth = 4; ctx.stroke();
        ctx.globalAlpha = 1.0;
        ctx.fillStyle = b.active ? "black" : "white"; ctx.font = "bold 40px Arial";
        ctx.textAlign = "center"; ctx.fillText(b.txt, b.x + b.w/2, b.y + b.h/2 + 15);
    }

    // Шкала тайминга
    if (state === "TIMING") {
        powerPoint += powerDir; if (powerPoint > 1 || powerPoint < 0) powerDir *= -1;
        ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(20, 430, 220, 40);
        ctx.fillStyle = powerPoint > 0.7 ? "#2ecc71" : "#e74c3c";
        ctx.fillRect(25, 435, 210 * powerPoint, 30);
    }

    // Текст
    ctx.fillStyle = "black"; ctx.font = "bold 45px Arial"; ctx.textAlign = "left";
    ctx.shadowColor = "white"; ctx.shadowBlur = 10;
    ctx.fillText("СЧЕТ: " + score, 40, 70);
    if (state === "RESULT") {
        ctx.textAlign = "center"; ctx.fillText(resultText, W/2, H/2);
    }

    if (state === "SHOT") {
        ball.x += ball.vx; ball.y += ball.vy; ball.vy += 0.5;
        if (ball.y > 750) { state = "RESULT"; resultText = "ПРОМАХ! НАЖМИ БРОСОК"; }
        if (Math.abs(ball.x - 640) < 40 && Math.abs(ball.y - 310) < 40) { 
            score += 3; state = "RESULT"; resultText = "ПОПАДАНИЕ! +3"; 
        }
    }
    requestAnimationFrame(draw);
}
courtImg.onload = draw;
</script>
</body>
</html>
