<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Basketball Pro Mobile</title>
    <style>
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: #000; position: fixed;
            touch-action: none; -webkit-user-select: none;
            font-family: sans-serif;
        }
        canvas { 
            display: block; width: 100vw; height: 100vh; 
            object-fit: contain; background: #000; 
        }
        #rotate-warning {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: white; text-align: center; z-index: 1000;
            flex-direction: column; justify-content: center; align-items: center;
        }
        @media (orientation: portrait) { #rotate-warning { display: flex; } }
    </style>
</head>
<body>
    <div id="rotate-warning">
        <h2>üèÄ –ü–µ—Ä–µ–≤–µ—Ä–Ω–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω</h2>
        <p>–î–ª—è –∏–≥—Ä—ã –Ω—É–∂–µ–Ω –∞–ª—å–±–æ–º–Ω—ã–π —Ä–µ–∂–∏–º</p>
    </div>
    <canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// –ë–∞–∑–æ–≤–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏–≥—Ä—ã
const W = 1280, H = 720;
canvas.width = W; canvas.height = H;

const FLOOR_Y = 650;
const hoop = { x: 640, y: 300, z: 120 };

const courtImg = new Image();
courtImg.src = "Basketball-Court-vector-illustra.jpg";

let state = "MOVE"; 
let mouse = { x: W/2, y: H/2 };
let score = 0;
let powerPoint = 0, powerDir = 0.008, finalTarget = { x: 0, y: 0 }, resultText = "";

const gravity = 0.45;
const ball = { x: 640, y: 600, z: 0, vx: 0, vy: 0, vz: 0, r: 22, active: false, bounced: false, isPerfect: false };

/* ================= INPUT ENGINE (FIXED) ================= */
function getTargetCoords(clientX, clientY) {
    const rect = canvas.getBoundingClientRect();
    // –í—ã—á–∏—Å–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è canvas –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —ç–∫—Ä–∞–Ω–∞
    const scaleX = W / rect.width;
    const scaleY = H / rect.height;
    return {
        x: (clientX - rect.left) * scaleX,
        y: (clientY - rect.top) * scaleY
    };
}

function handleInputStart(clientX, clientY) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const pos = getTargetCoords(clientX, clientY);
    mouse.x = pos.x; mouse.y = pos.y;

    if (state === "MOVE") {
        state = "AIM_LINE";
    } else if (state === "AIM_LINE") {
        finalTarget.x = mouse.x;
        finalTarget.y = mouse.y;
        state = "TIMING";
        powerPoint = 0;
    } else if (state === "TIMING") {
        shoot(powerPoint > 0.75);
        state = "SHOT";
    } else if (state === "RESULT") {
        state = "MOVE";
        ball.active = false;
        resultText = "";
    }
}

function handleInputMove(clientX, clientY) {
    const pos = getTargetCoords(clientX, clientY);
    mouse.x = pos.x;
    mouse.y = pos.y;
}

// TOUCH Events
canvas.addEventListener("touchstart", e => {
    e.preventDefault();
    handleInputStart(e.touches[0].clientX, e.touches[0].clientY);
}, {passive: false});

canvas.addEventListener("touchmove", e => {
    e.preventDefault();
    handleInputMove(e.touches[0].clientX, e.touches[0].clientY);
}, {passive: false});

// MOUSE Events (–¥–ª—è –ü–ö)
canvas.addEventListener("mousedown", e => handleInputStart(e.clientX, e.clientY));
canvas.addEventListener("mousemove", e => handleInputMove(e.clientX, e.clientY));

/* ================= AUDIO & VIBRATE ================= */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(freq, duration) {
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.type = "triangle"; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
    g.gain.setValueAtTime(0.1, audioCtx.currentTime);
    g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + duration);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + duration);
}

function vibrate(ms) { if (navigator.vibrate) navigator.vibrate(ms); }

/* ================= GAME LOGIC ================= */
function shoot(perfect) {
    ball.active = true; ball.bounced = false; ball.isPerfect = perfect;
    const T = 75;
    ball.vx = (hoop.x - ball.x) / T;
    ball.vz = (hoop.z - ball.z) / T;
    const heightErr = perfect ? 0 : (0.75 - powerPoint) * 10;
    ball.vy = (hoop.y - ball.y - 0.5 * gravity * T * T) / T + heightErr;
}

function update() {
    if (state === "MOVE") {
        ball.z = Math.max(0, Math.min(150, (1 - mouse.y / H) * 180));
        ball.x = mouse.x;
        ball.y = FLOOR_Y - ball.z * 1.5;
    }
    if (state === "TIMING") {
        powerPoint += powerDir
